#!/usr/bin/perl -w
# Copyright (C) 2000  Zephaniah E. Hull.
# This code is under the GNU GPL, see /usr/share/common-licenses/GPL.

use strict;
use Debconf::Client::ConfModule ':all';
# This is not elegant, nor clean, it was written at 4am and works.

main();

my (%types, %type_map);
BEGIN {
    %types = (
	"Voodoo 2"		=> "cvg",
	"Voodoo Banshee"	=> "h3",
	"Voodoo Banshee [Velocity 100]" => "h3",
	"Voodoo 3"		=> "h3",
    );
    %type_map = (
	"cvg"	=> "/usr/lib/glide2/libglide_cvg.so.2.53",
	"h3"	=> "/usr/lib/glide2/libglide_h3.so.2.60",
    );
}

sub main {
    my (@cards, $driver);
    version('2.0');
    title('glide2 configuration');

    @cards = get_devices();
    if ($#cards == -1) {
	my ($choice);
	input('low', 'libglide2/no_card');
	go();
	$choice = get('libglide2/no_card');
	if ($choice eq "true") {
	    input('low', 'libglide2/driver');
	    go();
	} else {
	    set('libglide2/driver', 'h3');
	    go();
	}
    } elsif ($#cards == 0) {
	set('libglide2/driver', ${$cards[0]}{'Driver'});
	go();
    } else {
	my (%card, $card, $choices, %choices, $choice, $tmp);

	for $card (@cards) {
	    %card = %$card;
	    if (defined($card{'SVendor'})) {
		$tmp = sprintf("%s %s (%s)", $card{'SVendor'}, $card{'SDevice'}, $card{'Device'});
	    } else {
		$tmp = sprintf("3Dfx %s", $card{'Device'});
	    }
	    $tmp =~ s/,//g;

	    $choices{$tmp} = $card{'Driver'};
	}

	$choices = join(', ', keys(%choices));
	subst('libglide2/card', 'choices', $choices);
	input('high', 'libglide2/card');
	go();
	$choice = get('libglide2/card');

	$tmp = $choices{$choice};
	set('libglide2/driver', $tmp);
    }
	
#    stop();
}

sub select_device {
    my ($type, $file, $target);
    $target = '/usr/lib/libglide.so.2';
    $type = shift;

    if (!defined($type_map{$type})) { die("No mapping for type " . $type); }
    $file = $type_map{$type};
    if (!-f $file) { die($file . " does not exist."); }

    if (-e $target) {
	if (-l $target) { unlink($target); } else {
	    die($target . " exists but is NOT a symlink!")
	}
    }
    symlink($file, "/usr/lib/libglide.so.2");
}

sub get_devices {
    my ($raw, $dev, $line, $tmp, @cards);
    $raw = `lspci -vm`;


    foreach $dev (split(/\n\n/, $raw)) {
	my (%info);
	foreach $line (split(/\n/, $dev)) {
	    if($line =~ /^(Class|Vendor|Device|SVendor|SDevice|Rev):\s+(.*)$/){
		$info{$1} = $2;
	    }
	}
	if (defined($types{$info{'Device'}})) {
	    $info{"Driver"} = $types{$info{"Device"}};
	    push(@cards, \%info);
	}
    }

    return @cards;
}

